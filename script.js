let cards = [  
  {
    rank: "2",
    value: 2,
    suit: "Hearts",
    src: "/assets/2heart.png"
  },
  {
    rank: "3",
    value: 3,
    suit: "Hearts",
    src: "/assets/3heart.png"
  },
  {
    rank: "4",
    value: 4,
    suit: "Hearts",
    src: "/assets/4heart.png"
  },
  {
    rank: "5",
    value: 5,
    suit: "Hearts",
    src: "/assets/5heart.png"   
  },
  {
    rank: "6",
    value: 6,
    suit: "Hearts",
    src: "/assets/6heart.png"
  },
  {
    rank: "7",
    value: 7,
    suit: "Hearts",
    src: "/assets/7heart.png"
  },
  {
    rank: "8",
    value: 8,
    suit: "Hearts",
    src: "/assets/8heart.png"
  },
  {
    rank: "9",
    value: 9,
    suit: "Hearts",
    src: "/assets/9heart.png"
  },
  {
    rank: "10",
    value: 10,
    suit: "Hearts",
    src: "/assets/10heart.png"
  },
  {
    rank: "J",
    value: 10,
    suit: "Hearts",
    src: "/assets/jheart.png" 
  },
  {
    rank: "Q",
    value: 10,
    suit: "Hearts",
    src: "/assets/qheart.png"
  },
  {
    rank: "K",
    value: 10,
    suit: "Hearts",
    src: "/assets/kheart.png"
  },
  {
    rank: "A",
    value: 11,
    suit: "Hearts",
    src: "/assets/aheart.png"
  },
  {
    rank: "2",
    value: 2,
    suit: "Diamonds",
    src: "/assets/2diamond.png"
  },
  {
    rank: "3",
    value: 3,
    suit: "Diamonds",
    src: "/assets/3diamond.png"
  },
  {
    rank: "4",
    value: 4,
    suit: "Diamonds",
    src: "/assets/4diamond.png"
  },
  {
    rank: "5",
    value: 5,
    suit: "Diamonds",
    src: "/assets/5diamond.png"
  },
  {
    rank: "6",
    value: 6,
    suit: "Diamonds",
    src: "/assets/6diamond.png"
  },
  {
    rank: "7",
    value: 7,
    suit: "Diamonds",
    src: "/assets/7diamond.png"
  },
  {
    rank: "8",
    value: 8,
    suit: "Diamonds",
    src: "/assets/8diamond.png"
  },
  {
    rank: "9",
    value: 9,
    suit: "Diamonds",
    src: "/assets/9diamond.png"
  },
  {
    rank: "10",
    value: 10,
    suit: "Diamonds",
    src: "/assets/10diamond.png"
  },
  {
    rank: "J",
    value: 10,
    suit: "Diamonds",
    src: "/assets/jdiamond.png"
  },
  {
    rank: "Q",
    value: 10,
    suit: "Diamonds",
    src: "/assets/qdiamond.png"
  },
  {
    rank: "K",
    value: 10,
    suit: "Diamonds",
    src: "/assets/kdiamond.png"
  },
  {
    rank: "A",
    value: 11,
    suit: "Diamonds",
    src: "/assets/adiamond.png"
    },
    {
        rank: "2",
        value: 2,
        suit: "Clubs",
        src: "/assets/2club.png"
    },
    {
        rank: "3",
        value: 3,
        suit: "Clubs",
        src: "/assets/3club.png"
    },
    {
        rank: "4",
        value: 4,
        suit: "Clubs",
        src: "/assets/4club.png"
    },
    {
        rank: "5",
        value: 5,
        suit: "Clubs",
        src: "/assets/5club.png"
    },
    {
        rank: "6",
        value: 6,
        suit: "Clubs",
        src: "/assets/6club.png"
    },
    {
        rank: "7",
        value: 7,
        suit: "Clubs",
        src: "/assets/7club.png"
    },
    {
        rank: "8",
        value: 8,
        suit: "Clubs",
        src: "/assets/8club.png"
    },
    {
        rank: "9",
        value: 9,
        suit: "Clubs",
        src: "/assets/9club.png"
    },
    {
      rank: "10",
      value: 10,
      suit: "Clubs",
      src: "/assets/10club.png"
    },
    {
        rank: "J",
        value: 10,
        suit: "Clubs",
        src: "/assets/jclub.png"
    },
    {
        rank: "Q",
        value: 10,
        suit: "Clubs",
        src: "/assets/qclub.png"
    },
    {
        rank: "K",
        value: 10,
        suit: "Clubs",
        src: "/assets/kclub.png"
    },
    {
        rank: "A",
        value: 11,
        suit: "Clubs",
        src: "/assets/aclub.png"
    },
    {
      rank: "2",
      value: 2,
      suit: "Spades",
      src: "/assets/2spades.png"
    },
    {
      rank: "3",
      value: 3,
      suit: "Spades",
      src: "/assets/3spades.png"
    },
    {
      rank: "4",
      value: 4,
      suit: "Spades",
      src: "/assets/4spades.png"
    },
    {
      rank: "5",
      value: 5,
      suit: "Spades",
      src: "/assets/5spades.png"
    },
    {
      rank: "6",
      value: 6,
      suit: "Spades",
      src: "/assets/6spades.png"
    },
    {
      rank: "7",
      value: 7,
      suit: "Spades",
      src: "/assets/7spades.png"
    },
    {
      rank: "8",
      value: 8,
      suit: "Spades",
      src: "/assets/8spades.png"
    },
    {
      rank: "9",
      value: 9,
      suit: "Spades",
      src: "/assets/9spades.png"
    },
    {
      rank: "10",
      value: 10,
      suit: "Spades",
      src: "/assets/10spades.png"
    },
    {
        rank: "J",
        value: 10,
        suit: "Spades",
        src: "/assets/jspades.png"
    },
    {
        rank: "Q",
        value: 10,
        suit: "Spades",
        src: "/assets/qspades.png"
    },
    {
        rank: "K",
        value: 10,
        suit: "Spades",
        src: "/assets/kspades.png"
    },
    {
        rank: "A",
        value: 11,
        suit: "Spades",
        src: "/assets/aspades.png"
     }
];
const newDeck = [...cards]; // Store the original deck to reset later
const drawCardSound = new Audio('/assets/drawcard.mp3');
const casino = new Audio('/assets/casino.mp3');
const winnerSound = new Audio('/assets/winner.mp3');
const youLoseSound = new Audio('/assets/youlose.mp3');
const placeYourBetSound = new Audio('/assets/bets.mp3');
const doubleDownSound = new Audio('/assets/double-down.mp3');
const noooSound = new Audio('/assets/nooo.mp3');
winnerSound.volume = 0.4;
youLoseSound.volume = 0.2;
const message = document.getElementById('message');
const musicIcon = document.getElementById('music-icon');
const playerHand = document.getElementById('player-hand');
const playerHand2 = document.getElementById('phs-2');
const myMoneyDisplay = document.getElementById('my-money');
const moneyWon = document.getElementById('money-won-item');
const currentBet = document.getElementById('current-bet');
const moneyBet = document.getElementById('money-lost-item');
const playerValueMessage = document.getElementById('player-value');
const dealerValueMessage = document.getElementById('dealer-value');
const dealerHandTitle = document.querySelector('.hand-title');
const playerHandTitle = document.querySelector('.player-hand-title');

let playerHandArray = [];
let playerHandArray2 = [];
let dealerHandArray = [];
let playerValue = 0;
let playerValue2 = 0;
let dealerValue = 0;
let gameActive = false;
let musicStopFlag = false;
let dealerCardSlot2;
let dealerHand;
let card1;
let card2;
let cardSlot1;
let cardSlot2;
let betAmount = 0;
let betAmountQuick = 0; // For quick bets
let myMoney = 2000; // Starting money
let counterFlag = 0; // Flag for quick bets
let myMoneyNegative = 0;
let hitOrStandFlag = false;
let doubleDownFlag = false;
let splitFlag = false;
let splitFlagLeftHand = false;
let splitFlagRightHand = false;
let youLoseLeftHand = false;
let youLoseRightHand = false;
let splitDealerFlag = false;
let flagLeave = false;
let unavailableLeaveFlag = false;

document.getElementById('start-button').addEventListener('click', function() {
  if(betAmount > 0) {
    document.getElementById('start-button').classList.add('hidden');
  }
});

function shuffleDeck(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]]; // Swap elements
  }
}

const drawCard = async () => {
  await new Promise(resolve => setTimeout(resolve, 500)); 
  drawCardSound.play();
  const cardDrawn = cards.shift();
  return cardDrawn;
};

const calculateHandValue = (hand) => {
  let sumHand = 0;
  let sumAces = 0;
  hand.forEach((card) => {
    sumHand = card.value + sumHand;
    if(card.rank === "A"){
      sumAces++;
    }
    while(sumHand > 21 && sumAces > 0){
      sumHand -= 10;
      sumAces--;
    }
  });
  return sumHand;
};

async function start() {
  playerHandTitle.classList.add("empty-title");
  dealerHandTitle.classList.add("empty-title");
  message.style.color = 'white';
  if(betAmount == 0) {
    message.innerHTML = 'Place your bet before starting the game';
    return;
  } else {
  cards = [...newDeck];
  shuffleDeck(cards);
  document.getElementById('next-round-button').classList.add('hidden');
  document.getElementById('leave-the-casino-button').classList.add('unavailable');
  unavailableLeaveFlag = true;
  document.getElementById('restart-button').classList.add('hidden');
  splitDealerFlag = false;
  dealerValueMessage.innerHTML = ""
  playerValueMessage.innerHTML = "";
  document.getElementById('player-hand').innerHTML = '';
  document.getElementById('dealer-hand').innerHTML = '';
  document.getElementById('phs-2').innerHTML = '';
  playerHand.classList.remove('split-style-left');
  playerHand2.classList.add('hidden');  
  message.innerHTML = '';
  gameActive = true;
  cardSlot1 = document.createElement('img');
  card1 = await drawCard();
  cardSlot1.classList.add('card');
  cardSlot1.src = card1.src;
  playerHand.appendChild(cardSlot1);
  cardSlot2 = document.createElement('img');
  card2 = await drawCard();
  cardSlot2.classList.add('card');
  cardSlot2.src = card2.src;
  playerHand.appendChild(cardSlot2);
  dealerHand = document.getElementById('dealer-hand');
  const dealerCardSlot1 = document.createElement('img');
  const dealerCard1 = await drawCard();
  dealerCardSlot1.classList.add('card');
  dealerCardSlot1.src = dealerCard1.src;
  dealerHand.appendChild(dealerCardSlot1);
  dealerCardSlot2 = document.createElement('img');
  const dealerCard2 = await drawCard();
  dealerCardSlot2.classList.add('card');
  dealerCardSlot2.src = "/assets/back.png";
  dealerHand.appendChild(dealerCardSlot2);

  playerHandArray = [card1, card2];
  dealerHandArray = [dealerCard1, dealerCard2];
  playerValue = calculateHandValue(playerHandArray);
  dealerValue = calculateHandValue(dealerHandArray);
  playerHandTitle.classList.remove("empty-title");
  dealerHandTitle.classList.remove("empty-title");
  message.innerHTML = `Your hand is ${playerValue}. Would you like to hit, stand or double down?`;
  setTimeout(() => {
   document.getElementById('hit-button').classList.remove('hidden');
   document.getElementById('stand-button').classList.remove('hidden');
   document.getElementById('double-down-button').classList.remove('hidden');
   document.getElementById('restart-button').classList.remove('hidden');
   hitOrStandFlag = true;
   doubleDownFlag = true;
   if(card1.rank == card2.rank){   
    splitFlag = true;
    message.innerHTML = `You got a pair! Your hand is ${playerValue}. Would you like to hit, stand, double down or split?`;
    document.getElementById('split-button').classList.remove('hidden');
   }
  }, 500);
}
}

const calculateWinAndLoseSplit = () => {
  if(youLoseLeftHand && youLoseRightHand){
    message.style.color = 'red';
    message.innerHTML = `You lose with both hands! You lose $${betAmount * 2}!`;
    gameActive = false;
    document.getElementById('hit-button').classList.add('hidden');
    document.getElementById('stand-button').classList.add('hidden');
    document.getElementById('double-down-button').classList.add('hidden');    
    document.getElementById('next-round-button').classList.remove('hidden');
    youLoseSound.play();
    youLoseLeftHand = false;
    youLoseRightHand = false;
    currentBet.innerHTML = 0; // Reset current bet 
    betAmount = 0; // Reset bet amount   
    checkLose();   
    return;
  } 
  finishRound();
};

async function finishRound() {
  doubleDownFlag = false;
  splitFlag = false;
  gameActive = false;
  // Reveal dealer's second card
  drawCardSound.play();
  dealerCardSlot2.src = dealerHandArray[1].src;
  dealerValue = calculateHandValue(dealerHandArray);
  
  if(splitDealerFlag){                // logic for finishing split round
   playerValueMessage.innerHTML = `Your left hand is ${playerValue} and your right hand is ${playerValue2}.`;
   message.innerHTML = "";
  while (dealerValue <= 19) {
    const newCardDealer = await drawCard();
    const newCardDealerSlot = document.createElement('img');
    newCardDealerSlot.classList.add('card');
    newCardDealerSlot.src = newCardDealer.src;
    dealerHand.appendChild(newCardDealerSlot);
    dealerHandArray.push(newCardDealer);
    dealerValue = calculateHandValue(dealerHandArray);
  }
  dealerValueMessage.innerHTML = `Dealer's hand is ${dealerValue}.`;  
    if((dealerValue > 21 && !youLoseLeftHand && !youLoseRightHand) || ((playerValue <= 21 && playerValue > dealerValue) && (playerValue2 <= 21 && playerValue2 > dealerValue))){
    message.style.color = '#85bb65';
    message.innerHTML = `You win with both your hands! You earned $${betAmount * 4}!`;
    winnerSound.play();
    myMoney += betAmount * 4;
    moneyWon.innerHTML = `+$${betAmount * 4}`;
  } else if(playerValue == dealerValue && playerValue2 == dealerValue){
    message.innerHTML = `You tied both hands! You got your money back!`;
    myMoney += betAmount * 2;
    moneyWon.innerHTML = `+$${betAmount * 2}`;
    setTimeout(() => {
    moneyWon.innerHTML = '';
    myMoneyDisplay.innerHTML = `$${myMoney}`;
    document.getElementById('my-money').style.color = 'white';
    }, 2000);  
    gameActive = false;
    document.getElementById('hit-button').classList.add('hidden');
    document.getElementById('stand-button').classList.add('hidden');
    document.getElementById('double-down-button').classList.add('hidden');    
    document.getElementById('next-round-button').classList.remove('hidden');
    youLoseLeftHand = false;
    youLoseRightHand = false;
    currentBet.innerHTML = 0; // Reset current bet 
    betAmount = 0; // Reset bet amount      
    return;
  } else if((playerValue2 == dealerValue) || (playerValue == dealerValue)){
    const message2 = document.createElement('p');
    message2.innerHTML = `One of the hands is a tie!`;
    message.appendChild(message2);
    myMoney += betAmount;
    moneyWon.innerHTML = `+$${betAmount}`;
  } else if((playerValue <= 21 && playerValue > dealerValue) || (playerValue2 <= 21 && playerValue2 > dealerValue) || (dealerValue > 21 && youLoseLeftHand) || (dealerValue > 21 && youLoseRightHand)){
    message.innerHTML = `You win with one of your hands! You earned $${betAmount * 2}!`;
    winnerSound.play();
    myMoney += betAmount * 2;
    moneyWon.innerHTML = `+$${betAmount * 2}`;
  } else if((playerValue > 21 || playerValue < dealerValue) && (playerValue2 > 21 || playerValue2 < dealerValue)){
    message.style.color = 'red';
    message.innerHTML = `You lose with both hands! You lose $${betAmount * 2}!`;
    youLoseSound.play();
  } else if((playerValue > 21 || playerValue < dealerValue) || (playerValue2 > 21 || playerValue2 < dealerValue)){  //(playerValue > 21 || playerValue < dealerValue)
    const message2 = document.createElement('p');
    message2.innerHTML = `You lose with one of your hands!`;
    youLoseSound.play();
    message.appendChild(message2);   
  } 
  setTimeout(() => {
    if(myMoney < 0){
      myMoneyNegative = -myMoney;
      myMoneyDisplay.innerHTML = `-$${myMoneyNegative}`;
      document.getElementById('my-money').style.color = 'red';
    } else {
    moneyWon.innerHTML = '';
    myMoneyDisplay.innerHTML = `$${myMoney}`;
    document.getElementById('my-money').style.color = 'white';
    }
  }, 2000);  
  currentBet.innerHTML = 0; // Reset current bet 
  betAmount = 0; // Reset bet amount    
  youLoseLeftHand = false;
  youLoseRightHand = false;
  splitFlag = false;
  splitDealerFlag = false;
  checkLose();
  document.getElementById('hit-button').classList.add('hidden');
  document.getElementById('stand-button').classList.add('hidden');
  document.getElementById('double-down-button').classList.add('hidden');    
  document.getElementById('next-round-button').classList.remove('hidden');  
  enableBetButtons();
  return;
  }
  
  // Dealer draws if needed
  while (dealerValue < playerValue) {
    const newCardDealer = await drawCard();
    const newCardDealerSlot = document.createElement('img');
    newCardDealerSlot.classList.add('card');
    newCardDealerSlot.src = newCardDealer.src;
    dealerHand.appendChild(newCardDealerSlot);
    dealerHandArray.push(newCardDealer);
    dealerValue = calculateHandValue(dealerHandArray);
  }

  // Determine winner
  dealerValueMessage.innerHTML = `Dealer's hand is ${dealerValue}.`;
  playerValueMessage.innerHTML = `Your hand is ${playerValue}.`;

  if ((playerValue <= 21 && playerValue > dealerValue) || dealerValue > 21) {  // Player wins
    myMoney += betAmount * 2;                                   // Player wins, double the bet
    document.getElementById('next-round-button').classList.remove('hidden');
    gameActive = false; 
    winnerSound.play();
    moneyWon.innerHTML = `+$${betAmount * 2}`;
    message.style.color = '#85bb65';
    message.innerHTML = `Player Wins! Nice, you won $${betAmount * 2}!`;
    setTimeout(() => {
      moneyWon.innerHTML = '';
      myMoneyDisplay.innerHTML = `$${myMoney}`;
      document.getElementById('my-money').style.color = 'white';
    }, 2000);  // Clear the bet message after 2 seconds
    currentBet.innerHTML = 0; // Reset current bet  
    betAmount = 0; // Reset bet amount

  } else if (playerValue > 21 || playerValue < dealerValue) {  // Dealer wins
    if(myMoney < 0) {
     myMoneyNegative = -myMoney;
     myMoneyDisplay.style.color = 'red';
     myMoneyDisplay.innerHTML = `-$${myMoneyNegative}`;
    } else {
     myMoneyDisplay.innerHTML = `$${myMoney}`;
    }
    message.style.color = 'red';
    message.innerHTML = `Dealer Wins! You lost $${betAmount}.`;
    currentBet.innerHTML = 0; // Reset current bet      
    betAmount = 0; // Reset bet amount
    document.getElementById('next-round-button').classList.remove('hidden');
    gameActive = false; 
    youLoseSound.play();
    checkLose();
    if (myMoney <= 0) {
      document.getElementById('next-round-button').classList.add('hidden');
    }

  } else {                                                     // Tie
    myMoney += betAmount;                                     // Tie, return the bet amount
    const moneyWon = document.getElementById('money-won-item');
    moneyWon.innerHTML = `+$${betAmount}`;
    setTimeout(() => {
      moneyWon.innerHTML = '';
      myMoneyDisplay.innerHTML = `$${myMoney}`;
      document.getElementById('my-money').style.color = 'white';
    }, 2000);  // Clear the bet message after 2 seconds
    currentBet.innerHTML = 0; // Reset current bet 
    betAmount = 0; // Reset bet amount   
    gameActive = false; 
    document.getElementById('next-round-button').classList.remove('hidden');   
    message.innerHTML = `Game is a tie!`;
  }
  document.getElementById('hit-button').classList.add('hidden');
  document.getElementById('stand-button').classList.add('hidden');
  document.getElementById('double-down-button').classList.add('hidden');
  document.getElementById('split-button').classList.add('hidden');
  if(myMoney > 0){
  document.getElementById('leave-the-casino-button').classList.remove('unavailable');
  unavailableLeaveFlag = false;
  }
  enableBetButtons();
}

document.getElementById('hit-button').addEventListener('click', async function() {    // hit buttton
  if (!gameActive) return;
  if (hitOrStandFlag) {
  hitOrStandFlag = false;
  doubleDownFlag = false;
  splitFlag = false;
  if(splitFlagRightHand){
  const newCard2 = await drawCard();
  playerHandArray2.push(newCard2);
  const newCardSlot2 = document.createElement('img');
  newCardSlot2.classList.add('card');
  newCardSlot2.src = newCard2.src;
  playerHand2.appendChild(newCardSlot2);
  playerValue2 = calculateHandValue(playerHandArray2);
  if (playerValue2 <= 21) {
     message.innerHTML = `Your right hand is ${playerValue2}. Would you like to hit or stand?`;
     hitOrStandFlag = true;
     return;
  } else if (playerValue2 > 21) {
      message.style.color = 'red';
      message.innerHTML = `Busted! Your right hand is ${playerValue2}.`;
      splitFlagRightHand = false;
      youLoseRightHand = true;
      splitDealerFlag = true;
      setTimeout(() => {
        message.style.color = 'white';
        calculateWinAndLoseSplit();
      }, 1000);
      return;
    }
  }
  const newCard = await drawCard();
  playerHandArray.push(newCard);
  const newCardSlot = document.createElement('img');
  newCardSlot.classList.add('card');
  newCardSlot.src = newCard.src;
  playerHand.appendChild(newCardSlot);
  playerValue = calculateHandValue(playerHandArray);
  document.getElementById('double-down-button').classList.add('hidden');
  if (playerValue <= 21) {
    if (splitFlagLeftHand) {
     message.innerHTML = `Your left hand is ${playerValue}. Would you like to hit or stand?`;
     hitOrStandFlag = true;
    } else {
     message.innerHTML = `Your hand is ${playerValue}. Would you like to hit or stand?`;
     hitOrStandFlag = true;
    }
  } else if (playerValue > 21) {
    if(splitFlagLeftHand){
      message.style.color = 'red';
      message.innerHTML = `Busted! Your left hand is ${playerValue}.`;
      splitFlagLeftHand = false;
      splitFlagRightHand = true;
      youLoseLeftHand = true;
      hitOrStandFlag = true;
      setTimeout(() => {
        message.style.color = 'white';
        message.innerHTML = `Your right hand is ${playerValue2}. Would you like to hit or stand?`;
      }, 2000);
      return;
    }   
    const myMoneyDisplay = document.getElementById('my-money');
    if(myMoney < 0) {
     myMoneyNegative = -myMoney;
     myMoneyDisplay.style.color = 'red';
     myMoneyDisplay.innerHTML = `-$${myMoneyNegative}`;
    } else {
     myMoneyDisplay.innerHTML = `$${myMoney}`;
    }
    if(myMoney > 0){
       document.getElementById('leave-the-casino-button').classList.remove('unavailable');
        unavailableLeaveFlag = false;
    }
    const currentBet = document.getElementById('current-bet');
    currentBet.innerHTML = 0; // Reset current bet  
    betAmount = 0; // Reset bet amount
    document.getElementById('next-round-button').classList.remove('hidden');
    gameActive = false; 
    youLoseSound.play();
    document.getElementById('hit-button').classList.add('hidden');
    document.getElementById('stand-button').classList.add('hidden');
    document.getElementById('double-down-button').classList.add('hidden');
    document.getElementById('split-button').classList.add('hidden');
    message.style.color = 'red';
    message.innerHTML = `Busted! Your hand is ${playerValue}.`;
    checkLose();
    if (myMoney <= 0) {
      document.getElementById('next-round-button').classList.add('hidden');
    }
  } else {
    finishRound();
  }
}
});

document.getElementById('stand-button').addEventListener('click', function() {       // stand button
  if (!gameActive) return;
  if (hitOrStandFlag){
  hitOrStandFlag = false;
  doubleDownFlag = false;
  splitFlag = false;
  if(splitFlagLeftHand){
    splitFlagLeftHand = false;
    splitFlagRightHand = true;
    hitOrStandFlag = true;
    message.innerHTML = `Your right hand is ${playerValue2}. Would you like to hit or stand?`;
    return;
  }
  if(splitFlagRightHand){
    splitFlagRightHand = false;
    message.innerHTML = `Your left hand is ${playerValue} and your right hand is ${playerValue2}. Let's see what the dealer got..`;
    splitDealerFlag = true;
  }
  calculateWinAndLoseSplit();
}
});

document.getElementById('double-down-button').addEventListener('click', async function(){   // double down button
  if(!gameActive) return;
  if(doubleDownFlag){
  doubleDownSound.play();
  const myMoneyDisplay = document.getElementById('my-money');
  const moneyBet = document.getElementById('money-lost-item');  
  myMoney -= betAmount;
  if(myMoney < 0) {
    moneyBet.innerHTML = `-$${betAmount}`;
    myMoneyNegative = -myMoney;
    myMoneyDisplay.style.color = 'red';
    setTimeout(() => {
      moneyBet.innerHTML = '';
      myMoneyDisplay.innerHTML = `-$${myMoneyNegative}`;
    }, 1000);
  } else {
    moneyBet.innerHTML = `-$${betAmount}`;
    setTimeout(() => {
      moneyBet.innerHTML = '';
      myMoneyDisplay.innerHTML = `$${myMoney}`;
    }, 1000);
  }
  betAmount = betAmount * 2;
  const currentBet = document.getElementById('current-bet');
  currentBet.innerHTML = `$${betAmount}`;
  const newCard = await drawCard();
  playerHandArray.push(newCard);
  const newCardSlot = document.createElement('img');
  newCardSlot.classList.add('card');
  newCardSlot.src = newCard.src;
  playerHand.appendChild(newCardSlot);
  playerValue = calculateHandValue(playerHandArray);
  document.getElementById('double-down-button').classList.add('hidden');
  doubleDownFlag = false;
  if (playerValue < 21) {
    message.innerHTML = `Your hand is ${playerValue}. Would you like to hit or stand?`;
    enableBetButtons();
  } else if (playerValue > 21) {
    if(myMoney < 0){
    setTimeout(() => {
     myMoneyDisplay.innerHTML = `-$${myMoneyNegative}`;
     currentBet.innerHTML = 0; // Reset current bet  
     betAmount = 0; // Reset bet amount
     document.getElementById('next-round-button').classList.remove('hidden');
     gameActive = false; 
     youLoseSound.play();
     document.getElementById('hit-button').classList.add('hidden');
     document.getElementById('stand-button').classList.add('hidden');
     message.style.color = 'red';
     message.innerHTML = `Busted! Your hand is ${playerValue}.`;
     enableBetButtons();
     checkLose();
    if (myMoney <= 0) {
      document.getElementById('next-round-button').classList.add('hidden');
    } 
    }, 1200);
  } else {
    setTimeout(() => {
     myMoneyDisplay.innerHTML = `$${myMoney}`;
     currentBet.innerHTML = 0; // Reset current bet  
     betAmount = 0; // Reset bet amount
     document.getElementById('next-round-button').classList.remove('hidden');
     gameActive = false; 
     youLoseSound.play();
     document.getElementById('hit-button').classList.add('hidden');
     document.getElementById('stand-button').classList.add('hidden');
     message.style.color = 'red';
     message.innerHTML = `Busted! Your hand is ${playerValue}.`;
     enableBetButtons();
     checkLose();
    }, 1200);
  }
  } else {
    finishRound();
  }  
}
});

document.getElementById('split-button').addEventListener('click', async function() {          // split button
  if(!gameActive) return;
  if(splitFlag){
     document.getElementById('split-button').classList.add('hidden'); 
     document.getElementById('double-down-button').classList.add('hidden'); 
     doubleDownFlag = false;
     splitFlag = false;
     splitFlagLeftHand = true;
     myMoney -= betAmount;
     if(myMoney < 0) {
      moneyBet.innerHTML = `-$${betAmount}`;
      myMoneyNegative = -myMoney;
      myMoneyDisplay.style.color = 'red';
      setTimeout(() => {
      moneyBet.innerHTML = '';
      myMoneyDisplay.innerHTML = `-$${myMoneyNegative}`;
      enableBetButtons();
      }, 1000);
     } else {
      moneyBet.innerHTML = `-$${betAmount}`;
      setTimeout(() => {
      moneyBet.innerHTML = '';
      myMoneyDisplay.innerHTML = `$${myMoney}`;
      enableBetButtons();
      }, 1000);
    }
     playerHandArray.pop();
     playerHand2.classList.remove('hidden');
     playerHand.removeChild(cardSlot2);
     playerHand2.appendChild(cardSlot2);
     playerHandArray2 = [card2];
     playerHand.classList.add('split-style-left');
     playerHand2.classList.add('split-style-right');
     const newCard = await drawCard();
     playerHandArray.push(newCard);
     const newCardSlot = document.createElement('img');
     newCardSlot.classList.add('card');
     newCardSlot.src = newCard.src;
     playerHand.appendChild(newCardSlot);
     playerValue = calculateHandValue(playerHandArray);
     const newRightCard = await drawCard();
     playerHandArray2.push(newRightCard);
     const newRightCardSlot = document.createElement('img');
     newRightCardSlot.classList.add('card');
     newRightCardSlot.src = newRightCard.src;     
     playerHand2.appendChild(newRightCardSlot);
     playerValue2 = calculateHandValue(playerHandArray2);
     message.innerHTML = `You split into two hands! Your left hand is ${playerValue}. Would you like to hit or stand?`;
  }
});

function addBet(amount) {
  if (!gameActive) {
    if (betAmount === 0 && !musicStopFlag) {
      musicIcon.innerHTML = "üîä";
      casino.volume = 0.2;
      placeYourBetSound.volume = 0.4;
      casino.play();
      casino.loop = true;
      placeYourBetSound.play();
    }
    const currentBet = document.getElementById('current-bet');
    const myMoneyDisplay = document.getElementById('my-money');
    myMoney -= amount; // Subtract the bet amount from player's money
    betAmount = betAmount + parseInt(amount);
    betAmountQuick = betAmountQuick + parseInt(amount); // For quick bets
    moneyBet.innerHTML = `-$${betAmountQuick}`;
    currentBet.innerHTML = `$${betAmount}`;
    if(counterFlag == 0) {
    setTimeout(() => {
    moneyBet.innerHTML = '';
    myMoneyDisplay.innerHTML = `$${myMoney}`;
    betAmountQuick = 0; // Reset the quick bet amount
    counterFlag = 0; // Reset the counter flag
    }, 1000);  // Clear the bet message after 1 second
    }
    counterFlag++;
    enableBetButtons();
    if(myMoney <= 0){
      document.getElementById('leave-the-casino-button').classList.add('unavailable');
      unavailableLeaveFlag = true;
    } 
  }
}

function allIn() {
  if (!gameActive) {
    if (betAmount === 0 && !musicStopFlag) {
      musicIcon.innerHTML = "üîä";
      casino.volume = 0.2;
      placeYourBetSound.volume = 0.4;
      casino.play();
      casino.loop = true;
      placeYourBetSound.play();
    }
  betAmount = betAmount + myMoney;
  const myMoneyDisplay = document.getElementById('my-money');
  const currentBet = document.getElementById('current-bet');
  moneyBet.innerHTML = `-$${myMoney}`;
  currentBet.innerHTML = `$${betAmount}`;
  myMoney = 0;  
  setTimeout(() => {
    moneyBet.innerHTML = '';
    myMoneyDisplay.innerHTML = `$${myMoney}`;
    }, 1000); // Clear the bet message after 0.5 second
  enableBetButtons();
  if(myMoney <= 0){
    document.getElementById('leave-the-casino-button').classList.add('unavailable');
    unavailableLeaveFlag = true;
  } 
}
}

function clearBet() {
  if (!gameActive && betAmount > 0) {
    myMoney += betAmount; // Return the bet amount to player's money
    const myMoneyDisplay = document.getElementById('my-money');
    const currentBet = document.getElementById('current-bet');
    const moneyWon = document.getElementById('money-won-item');
    moneyWon.innerHTML = `+$${betAmount}`;

    setTimeout(() => {
      moneyWon.innerHTML = '';
      myMoneyDisplay.innerHTML = `$${myMoney}`;
    }, 1000); // Clear the bet message after 0.5 second
    betAmount = 0;
    currentBet.innerHTML = betAmount; // Reset current bet    
    enableBetButtons();
    if(myMoney > 0){
      document.getElementById('leave-the-casino-button').classList.remove('unavailable');
      unavailableLeaveFlag = false;
    }
  }
}

function enableBetButtons() {
    const thousandButton = document.getElementById('bet-button-1000');
    const fiveHundredButton = document.getElementById('bet-button-500');
    const oneHundredButton = document.getElementById('bet-button-100');
    const fiftyButton = document.getElementById('bet-button-50');
    const twentyButton = document.getElementById('bet-button-20');
    const tenButton = document.getElementById('bet-button-10');
    const allInButton = document.getElementById('allin-bet-button');
    if (myMoney <= 0) {
      allInButton.disabled = true;
      allInButton.classList.add('disabled');
    } else {
      allInButton.disabled = false;
      allInButton.classList.remove('disabled');
    }
    if (myMoney < 1000) {
      thousandButton.disabled = true;
      thousandButton.classList.add('disabled');
    } else {
      thousandButton.disabled = false;
      thousandButton.classList.remove('disabled');
    }

    if (myMoney < 500) {
     fiveHundredButton.disabled = true;
     fiveHundredButton.classList.add('disabled');
    } else {
     fiveHundredButton.disabled = false;
     fiveHundredButton.classList.remove('disabled');
    }

    if (myMoney < 100) {
     oneHundredButton.disabled = true;
     oneHundredButton.classList.add('disabled');
    } else {
     oneHundredButton.disabled = false;
     oneHundredButton.classList.remove('disabled');
    }

   if (myMoney < 50) {
    fiftyButton.disabled = true;
    fiftyButton.classList.add('disabled');
   } else {
    fiftyButton.disabled = false;
    fiftyButton.classList.remove('disabled');
   }

   if (myMoney < 20) {
    twentyButton.disabled = true;
    twentyButton.classList.add('disabled');
   } else {
    twentyButton.disabled = false;
    twentyButton.classList.remove('disabled');
   }

   if (myMoney < 10) {
    tenButton.disabled = true;
    tenButton.classList.add('disabled');
   } else {
    tenButton.disabled = false;
    tenButton.classList.remove('disabled');
   }
}

function playMusic() {
  casino.loop = true;
  casino.volume = 0.2;
  if(casino.paused){
    musicIcon.innerHTML = "üîä";
    casino.play();
  } else {
    musicIcon.innerHTML = "üîá";
    casino.pause();
    musicStopFlag = true;
  }
}

function checkLose() {
  if(myMoney == 0){
   setTimeout(() => {
    casino.pause();
    document.getElementById('popup-lose').style.display = 'block';
    document.getElementById('modal-backdrop-lose').style.display = 'block';
   }, 2000);
  } else if(myMoney < 0){
   setTimeout(() => {
    casino.pause();
    noooSound.volume = 0.1;
    noooSound.play();
    const img = document.getElementById('img-src');
    const title = document.getElementById('title-src');
    title.innerHTML = `You f*cked up! You owe the casino $${-myMoney}!`;
    img.src = "assets/owethecasino.jpg";
    document.getElementById('popup-lose').style.display = 'block';
    document.getElementById('modal-backdrop-lose').style.display = 'block';      
   }, 2000);     
 }
}

document.getElementById('showControls').addEventListener('click', function() {
  document.getElementById('popup').style.display = 'block';
  document.getElementById('modal-backdrop').style.display = 'block';
});

document.getElementById('closePopup').addEventListener('click', function() {
  document.getElementById('popup').style.display = 'none';
  document.getElementById('modal-backdrop').style.display = 'none';
});

//leave casino and add record
document.getElementById('leave-the-casino-button').addEventListener('click', function() {
  if(unavailableLeaveFlag) return;
  if(myMoney > 0){
  flagLeave = true;
  document.getElementById('popup-leave').style.display = 'block';
  document.getElementById('modal-backdrop-leave').style.display = 'block';
  }
});

document.getElementById('closePopup-leave').addEventListener('click', function() {
  document.getElementById('popup-leave').style.display = 'none';
  document.getElementById('modal-backdrop-leave').style.display = 'none';
  flagLeave = false;
  history.pushState(null, '', '/');
});

document.getElementById('recordButton').addEventListener('click', async function() {
  const name = document.getElementById('namePlayer').value;
  const money = myMoney; 

  // Send POST request to server
  const response = await fetch('http://localhost:1000/leavecasino', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, money })
  });

  if (response.ok) {
    // Optionally show a success message or redirect
    alert('Your record has been saved!');
    // window.location.href = '/'; // redirect if you want
  } else {
    alert('Error saving your record.');
  }
});

document.getElementById('showRecords').addEventListener('click', async function() {
fetch('http://localhost:1000/showrecords')
  .then(res => res.json())
  .then(data => {
  const listRecords = document.getElementById('highscores-list');
  listRecords.innerHTML = ''; // Clear previous records
  data.result.forEach(entry => {
    const record = document.createElement('li');
    record.classList.add('record-row'); 
    record.innerHTML = `${entry.name}...................................`;
    const recordMoney = document.createElement('span');
    recordMoney.innerHTML = `$${entry.record.toLocaleString('de-DE')}`;
    recordMoney.classList.add('record-money');
    record.appendChild(recordMoney);
    listRecords.appendChild(record);
  });
});
  document.getElementById('popup-records').style.display = 'block';
  document.getElementById('modal-backdrop-records').style.display = 'block';
});

document.getElementById('closePopup-records').addEventListener('click', function() {
  document.getElementById('popup-records').style.display = 'none';
  document.getElementById('modal-backdrop-records').style.display = 'none';
});

function restart() {
  playerHandTitle.classList.add("empty-title");
  dealerHandTitle.classList.add("empty-title");
  message.style.color = 'white';
  cards = [...newDeck]; // Reset the deck to the original
  stand = false;
  unavailableLeaveFlag = false;
  noooSound.pause();
  noooSound.currentTime = 0;
  playerHandArray = [];
  playerHandArray2 = [];
  dealerHandArray = [];
  playerValue = 0;
  playerValue2 = 0;
  dealerValue = 0;
  gameActive = false;
  playerHand.innerHTML = '';
  dealerHand.innerHTML = '';
  const emptyCard = document.createElement('img');
  emptyCard.classList.add('empty-card');
  emptyCard.src = 'assets/empty-card.png';
  const emptyCard2 = document.createElement('img');
  emptyCard2.classList.add('empty-card');
  emptyCard2.src = 'assets/empty-card.png';
  playerHand.appendChild(emptyCard);
  dealerHand.appendChild(emptyCard2);
  document.getElementById('phs-2').innerHTML = '';
  document.getElementById('message').innerHTML = 'Welcome to Blackjack Casino Royale!';
  document.getElementById('player-value').innerHTML = '';
  document.getElementById('dealer-value').innerHTML = '';
  document.getElementById('start-button').classList.remove('hidden');
  document.getElementById('hit-button').classList.add('hidden');
  document.getElementById('stand-button').classList.add('hidden');
  document.getElementById('double-down-button').classList.add('hidden');
  document.getElementById('restart-button').classList.add('hidden');
  document.getElementById('next-round-button').classList.add('hidden');
  document.getElementById('message').classList.remove('busted');
  playerHand.classList.remove('split-style-left');
  playerHand2.classList.add('hidden');  
  betAmount = 0;
  myMoney = 2000; // Reset money
  const myMoneyDisplay = document.getElementById('my-money');
  myMoneyDisplay.innerHTML = `$${myMoney}`;
  document.getElementById('my-money').style.color = 'white';
  hitOrStandFlag = false;
  doubleDownFlag = false;
  splitFlag = false;
  splitFlagLeftHand = false;
  splitFlagRightHand = false;
  youLoseLeftHand = false;
  youLoseRightHand = false;
  splitDealerFlag = false;
  document.getElementById('popup-lose').style.display = 'none';
  document.getElementById('modal-backdrop-lose').style.display = 'none';
  const img = document.getElementById('img-src');
  const title = document.getElementById('title-src');
  title.innerHTML = `You lost all your money!`;
  img.src = "assets/cero.jpg";
  enableBetButtons();
}

window.onkeyup = function (event) {
 if(!flagLeave){   
  if (event.keyCode == 13) {    //enter to start game and next round
     if(!gameActive){
      start();
     if(betAmount > 0) {
    document.getElementById('start-button').classList.add('hidden');
    }
    }}
    if (event.keyCode == 77) {
     playMusic();
    }
    if(myMoney > 0){
    if (event.keyCode == 65) {
     allIn();
    }}
    if (event.keyCode == 67) {
     clearBet();
    }    
    if (event.keyCode == 82) {
     restart();
    }  
    if (event.keyCode == 72) {
     document.getElementById('hit-button').click();
    }
    if (event.keyCode == 83) {
     document.getElementById('stand-button').click();
    }
    if (event.keyCode == 68) {
     document.getElementById('double-down-button').click();
    }
    if (event.keyCode == 90) {
     document.getElementById('split-button').click();
    }
    if(myMoney >= 10){     
    if (event.keyCode == 49 || event.keyCode == 97) {
     addBet(10);
    }}
    if(myMoney >= 20){    
    if (event.keyCode == 50 || event.keyCode == 98) {
     addBet(20);
    }}
    if(myMoney >= 50){    
    if (event.keyCode == 51 || event.keyCode == 99) {
     addBet(50);
    }}
    if(myMoney >= 100){    
    if (event.keyCode == 52 || event.keyCode == 100) {
     addBet(100);
    }}
    if(myMoney >= 500){      
    if (event.keyCode == 53 || event.keyCode == 101) {
     addBet(500);
    }}
    if(myMoney >= 1000){    
    if (event.keyCode == 54 || event.keyCode == 102) {
     addBet(1000);
    }}
  }
if (event.keyCode == 27){
  document.getElementById('popup').style.display='none';
  document.getElementById('modal-backdrop').style.display = 'none';
  document.getElementById('popup-leave').style.display='none';
  document.getElementById('modal-backdrop-leave').style.display = 'none';
  document.getElementById('popup-records').style.display='none';
  document.getElementById('modal-backdrop-records').style.display = 'none';  
  flagLeave = false;
 }
}

document.getElementById('namePlayer').addEventListener('input', function(e) {
  // Solo permite letras y n√∫meros
  this.value = this.value.replace(/[^a-zA-Z0-9]/g, '');
});